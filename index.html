<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>String Meter · Safe Guitar Tuner</title>
  <style>
    :root { --ok:#1b5e20; --near-low:#c99700; --near-high:#c62828; }
    body{
      font-family:system-ui,-apple-system,"Apple SD Gothic Neo";
      margin:0;
      padding:28px 12px 18px;
      color:#111;
      background:#fafafa;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      box-sizing:border-box;
      gap:20px;
      text-align:center;
    }
    h1{margin:0;font-size:1.8rem;font-weight:700}
    h2{margin:4px 0 0;font-size:1rem;font-weight:400;color:#555}
    #status{font-size:.78rem;color:#c62828;min-height:1em}
    .center-area{
      display:flex;
      gap:28px;
      justify-content:center;
      align-items:center;
      width:100%;
      max-width:760px;
    }
    .meter{
      position:relative;
      width:90px;
      height:80vh;
      max-height:540px;
      min-height:420px;
      border:1px solid #ddd;
      border-radius:14px;
      background:linear-gradient(180deg,#f9f9f9,#f1f1f1);
      flex:0 0 auto;
    }
    .fill{
      position:absolute;left:0;bottom:0;width:100%;height:0;
      background:linear-gradient(180deg,#66bb6a,#2e7d32);
      border-radius:14px 14px 10px 10px;transition:height .12s ease-out;
    }
    .freq-tag{
      position:absolute;left:-118px;top:50%;transform:translateY(-50%);
      background:rgba(255,255,255,.9);padding:4px 10px;border-radius:10px;
      border:1px solid #ddd;font-size:13px;white-space:nowrap;
    }
    .scale{
      position:relative;
      height:80vh;
      max-height:540px;
      min-height:420px;
      width:240px;
      flex:0 0 auto;
    }
    .tick{position:absolute;left:0;transform:translateY(50%)}
    .dash{display:inline-block;width:22px;height:2px;background:#999;margin-right:8px}
    .lbl{display:inline-block;color:#333;transition:color .1s,font-weight .1s}
    .lbl.ok{color:var(--ok);font-weight:700}
    .lbl.near-low{color:var(--near-low);font-weight:700}
    .lbl.near-high{color:var(--near-high);font-weight:700}
    @media (max-width:620px){
      .center-area{flex-direction:column;gap:14px;}
      .freq-tag{left:calc(100% + 10px);}  
    }
  </style>
</head>
<body>
  <div>
    <h1>String Meter</h1>
    <h2>Safe Guitar Tuner</h2>
  </div>
  <div id="status"></div>
  <div class="center-area">
    <div class="meter">
      <div id="fill" class="fill"></div>
      <div id="freq" class="freq-tag">-- Hz</div>
    </div>
    <div class="scale" id="scale"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/aubiojs@0.1.1/build/aubio.min.js"></script>
  <script>
  const STR=[
    {no:1,name:"E4",f:329.6276},
    {no:2,name:"B3",f:246.9417},
    {no:3,name:"G3",f:195.9977},
    {no:4,name:"D3",f:146.8324},
    {no:5,name:"A2",f:110.0000},
    {no:6,name:"E2",f:82.4069},
  ];
  const CORR=[329.6276/331.3,246.9417/247.7,195.9977/197.5,146.8324/147.6,110.0/110.5,82.4069/82.9];
  const SEMI=Math.pow(2,1/12);
  const FMAX=STR[0].f*Math.pow(SEMI,4);
  const FMIN=STR[5].f/Math.pow(SEMI,4);
  const OK_CENTS=2,NEAR_CENTS=40;
  const scaleEl=document.getElementById('scale');
  const fillEl=document.getElementById('fill');
  const freqTag=document.getElementById('freq');
  const statusEl=document.getElementById('status');
  const stringDom={};

  function log2(x){return Math.log(x)/Math.LN2}
  function clamp(v,a,b){return v<a?a:v>b?b:v}
  function cents(a,b){return 1200*Math.log2(a/b)}
  function mapLogPct(f){const p=(log2(f)-log2(FMIN))/(log2(FMAX)-log2(FMIN));return clamp(p,0,1)}
  function nearestIdx(f){let k=0,m=1e9;for(let i=0;i<STR.length;i++){const d=Math.abs(cents(f,STR[i].f));if(d<m){m=d;k=i}}return k;}

  function addTick(freq,label){
    const t=document.createElement('div');t.className='tick';
    t.style.bottom=(mapLogPct(freq)*100)+'%';
    t.innerHTML=`<span class="dash"></span><span class="lbl">${label}</span>`;
    scaleEl.appendChild(t);
    return t.querySelector('.lbl');
  }
  (function layout(){
    addTick(FMAX,'Danger!');
    for(const s of STR){const el=addTick(s.f,`${s.no}번 (${s.name})`);stringDom[s.no]={el,base:`${s.no}번 (${s.name})`};}
    addTick(FMIN,'Low');
  })();

  class MiniTuner{
    constructor(a4){this.middleA=a4||440;this.bufferSize=4096;this.ready=false;}
    init(){
      this.audioContext=new (window.AudioContext||window.webkitAudioContext)();
      this.analyser=this.audioContext.createAnalyser();
      this.scriptProcessor=this.audioContext.createScriptProcessor(this.bufferSize,1,1);
      const self=this;
      aubio().then(function(a){
        self.pitchDetector=new a.Pitch("default", self.bufferSize, 1, self.audioContext.sampleRate);
        self.ready=true;
      }).catch(function(err){statusEl.textContent='피치 엔진 로드 실패: '+err.message;});
    }
    start(){
      const self=this;
      if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){statusEl.textContent='이 환경에서는 마이크를 사용할 수 없습니다.';return;}
      navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
        const src=self.audioContext.createMediaStreamSource(stream);
        src.connect(self.analyser);
        self.analyser.connect(self.scriptProcessor);
        self.scriptProcessor.connect(self.audioContext.destination);
        self.scriptProcessor.addEventListener('audioprocess',function(e){
          if(!self.ready)return;const input=e.inputBuffer.getChannelData(0);const freq=self.pitchDetector.do(input);if(freq&&self.onNoteDetected){self.onNoteDetected(freq);}});
        if(self.audioContext.state==='suspended')self.audioContext.resume();
      }).catch(err=>{console.error('마이크 오류:',err);statusEl.textContent='마이크를 사용할 수 없습니다.';});
    }
  }

  let lastName=null;let lockUntil=0;const HOLD_MS=1200;
  function renderGuitarFrequency(f){
    const idx=nearestIdx(f), s=STR[idx];
    fillEl.style.height=(mapLogPct(f)*100)+'%';
    freqTag.textContent=f.toFixed(2)+' Hz';
    for(const k in stringDom){const L=stringDom[k].el;L.classList.remove('ok','near-low','near-high');L.textContent=stringDom[k].base;}
    const d=cents(f,s.f), ad=Math.abs(d), L=stringDom[s.no].el;
    if(ad<=OK_CENTS){L.classList.add('ok');}
    else if(ad<=NEAR_CENTS){L.classList.add(d<0?'near-low':'near-high');L.textContent=`${stringDom[s.no].base} (${d>0?'+':''}${d.toFixed(0)})`;}
    lockUntil=performance.now()+HOLD_MS;
  }

  const tuner=new MiniTuner(440);
  tuner.init();
  document.addEventListener('DOMContentLoaded',()=>{
    tuner.onNoteDetected=function(freq){
      const now=performance.now();
      if(freq<70||freq>500)return;
      const idx=nearestIdx(freq);
      const corrected=freq*(CORR[idx]||1.0);
      const s=STR[idx];
      const name=`${s.no}`;
      if(name!==lastName){lastName=name;return;}
      if(now<lockUntil)return;
      renderGuitarFrequency(corrected);
    };
    tuner.start();
  });
  </script>
</body>
</html>
